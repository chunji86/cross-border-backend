<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>공급사 대시보드</title>

  <!-- Tailwind CDN (빠른 시연용) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- 사용자 제공 CSS (선택) -->
  <link rel="stylesheet" href="/public/css/style.css">
  <!-- ↑ /public/css/style.css 로 복사해 두세요 -->
</head>
<body class="bg-gray-50 min-h-screen">
  <header class="bg-white border-b sticky top-0 z-10">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <h1 class="text-xl font-semibold">공급사 대시보드</h1>
      <div class="text-sm text-gray-500">읽기 전용 · Cafe24 연동</div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-6 space-y-8">
    <!-- 연결/상태 영역 -->
    <section class="bg-white rounded-xl border p-4">
      <div class="flex flex-wrap items-end gap-3">
        <div>
          <label class="block text-sm text-gray-600">mall_id</label>
          <input id="mall" class="border rounded px-3 py-2" value="hanfen" />
        </div>
        <div>
          <label class="block text-sm text-gray-600">shop_no</label>
          <input id="shop" type="number" class="border rounded px-3 py-2 w-24" value="1" min="1"/>
        </div>
        <div class="flex gap-2">
          <button id="btnStatus" class="btn btn-primary bg-blue-600 text-white px-4 py-2 rounded">상태 조회</button>
          <button id="btnSync"   class="px-4 py-2 rounded border">주문 동기화</button>
        </div>
        <div class="ml-auto text-sm text-gray-500">
          <span id="pill" class="inline-block px-2 py-1 rounded border">-</span>
        </div>
      </div>

      <div class="mt-3 flex flex-wrap items-end gap-3">
        <div>
          <label class="block text-sm text-gray-600">동기화 시작일</label>
          <input id="startDate" type="date" class="border rounded px-3 py-2"/>
        </div>
        <div>
          <label class="block text-sm text-gray-600">동기화 종료일</label>
          <input id="endDate" type="date" class="border rounded px-3 py-2"/>
        </div>
        <div class="text-sm text-gray-500">기본: 최근 7일</div>
      </div>
    </section>

    <!-- KPI -->
    <section class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <div class="bg-white rounded-xl border p-4">
        <div class="text-sm text-gray-500">상품 수</div>
        <div id="kpiProducts" class="text-2xl font-semibold">-</div>
      </div>
      <div class="bg-white rounded-xl border p-4">
        <div class="text-sm text-gray-500">주문 수(전체)</div>
        <div id="kpiOrders" class="text-2xl font-semibold">-</div>
      </div>
      <div class="bg-white rounded-xl border p-4">
        <div class="text-sm text-gray-500">구매확정 주문 수</div>
        <div id="kpiConfirmed" class="text-2xl font-semibold">-</div>
      </div>
    </section>

    <!-- 상품 목록 -->
    <section class="bg-white rounded-xl border">
      <div class="p-4 flex items-center justify-between gap-3">
        <h2 class="font-semibold">상품 목록</h2>
        <div class="flex items-center gap-2 text-sm">
          <label>페이지</label>
          <input id="prodPage" type="number" value="1" min="1" class="border rounded px-2 py-1 w-20">
          <label>개수</label>
          <input id="prodLimit" type="number" value="50" min="1" max="100" class="border rounded px-2 py-1 w-20">
          <button id="btnLoadProducts" class="px-3 py-1 rounded border">새로고침</button>
        </div>
      </div>
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead class="bg-gray-100 text-gray-600">
            <tr>
              <th class="text-left px-4 py-2">상품번호</th>
              <th class="text-left px-4 py-2">상품명</th>
              <th class="text-left px-4 py-2">가격</th>
              <th class="text-left px-4 py-2">상세</th>
            </tr>
          </thead>
          <tbody id="product-list"></tbody>
        </table>
      </div>
    </section>

    <!-- 주문 목록 -->
    <section class="bg-white rounded-xl border">
      <div class="p-4 flex items-center justify-between gap-3">
        <h2 class="font-semibold">주문 목록</h2>
        <div class="flex items-center gap-2 text-sm">
          <label>확정 필터</label>
          <select id="confirmedSel" class="border rounded px-2 py-1">
            <option value="all">전체</option>
            <option value="1">구매확정만</option>
            <option value="0">미확정만</option>
          </select>
          <button id="btnLoadOrders" class="px-3 py-1 rounded border">새로고침</button>
        </div>
      </div>
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead class="bg-gray-100 text-gray-600">
            <tr>
              <th class="text-left px-4 py-2">주문번호</th>
              <th class="text-left px-4 py-2">대표상품</th>
              <th class="text-left px-4 py-2">수량</th>
              <th class="text-left px-4 py-2">결제금액</th>
              <th class="text-left px-4 py-2">인플루언서</th>
              <th class="text-left px-4 py-2">배송/확정 상태</th>
            </tr>
          </thead>
          <tbody id="order-list"></tbody>
        </table>
      </div>
    </section>

    <!-- 로그 -->
    <section class="bg-white rounded-xl border p-4">
      <div class="text-sm text-gray-500">최근 응답</div>
      <pre id="out" class="bg-gray-900 text-gray-200 rounded p-3 overflow-auto" style="max-height:280px;">{}</pre>
    </section>
  </main>

  <script>
  const $ = (id)=>document.getElementById(id);
  const BASE = window.location.origin; // 같은 서버에서 API 호출

  function setPill(txt, ok=true) {
    const el = $('pill');
    el.textContent = txt;
    el.className = 'inline-block px-2 py-1 rounded border ' + (ok ? 'text-green-700 border-green-300' : 'text-amber-700 border-amber-300');
  }
  function showLog(obj){ $('out').textContent = JSON.stringify(obj, null, 2); }

  // KPI 집계
  function sumQty(items){ return (items||[]).reduce((s,it)=> s + (Number(it.qty)||0), 0); }

  // 상품 불러오기
  async function loadProducts(){
    const mall_id = $('mall').value, shop_no = $('shop').value;
    const page = Number($('prodPage').value||1), limit = Math.max(1, Math.min(100, Number($('prodLimit').value||50)));
    const url = `${BASE}/api/cafe24/shop/products?mall_id=${mall_id}&shop_no=${shop_no}&limit=${limit}&page=${page}`;
    const r = await fetch(url); const j = await r.json(); showLog(j);

    const list = (j?.data?.products || j?.products || []);
    $('kpiProducts').textContent = list.length;
    const tbody = $('product-list'); tbody.innerHTML = '';
    list.forEach(p=>{
      const price = p.selling_price ?? p.price ?? '';
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="px-4 py-2">${p.product_no||''}</td>
        <td class="px-4 py-2">${p.product_name||p.name||''}</td>
        <td class="px-4 py-2">${price}</td>
        <td class="px-4 py-2">
          <a class="text-blue-600 underline" target="_blank"
             href="${BASE}/api/cafe24/shop/product/${p.product_no}/lean?mall_id=${mall_id}&shop_no=${shop_no}">
            lean 보기
          </a>
        </td>`;
      tbody.appendChild(tr);
    });
  }

  // 주문 불러오기
  async function loadOrders(){
    const mall_id = $('mall').value, shop_no = $('shop').value;
    const sel = $('confirmedSel').value;
    const q = sel==='all' ? '' : `&confirmed=${sel}`;
    const url = `${BASE}/api/cafe24/orders/list?mall_id=${mall_id}&shop_no=${shop_no}${q}`;
    const r = await fetch(url); const j = await r.json(); showLog(j);

    const list = j?.orders || [];
    $('kpiOrders').textContent = list.length;
    $('kpiConfirmed').textContent = list.filter(o=>!!o.purchaseconfirmation_date).length;

    const tbody = $('order-list'); tbody.innerHTML = '';
    list.forEach(o=>{
      const name = (o.items?.[0]?.name) || '-';
      const qty = sumQty(o.items);
      const amount = o.total_price ?? 0;
      const infl = o.influencer_id || '—';

      let status = '미발송';
      if (o.shipbegin_date) status = '배송중';
      if (o.shipend_date)   status = '배송완료';
      if (o.purchaseconfirmation_date) status = '구매확정';

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="px-4 py-2">${o.order_no||''}</td>
        <td class="px-4 py-2">${name}</td>
        <td class="px-4 py-2">${qty}</td>
        <td class="px-4 py-2">${amount}</td>
        <td class="px-4 py-2">${infl}</td>
        <td class="px-4 py-2">${status}</td>`;
      tbody.appendChild(tr);
    });
  }

  // 상태 조회 (토큰 잔여 시간 등)
  async function checkStatus(){
    const mall_id = $('mall').value, shop_no = $('shop').value;
    const url = `${BASE}/api/cafe24/ops/status?mall_id=${mall_id}&shop_no=${shop_no}`;
    const r = await fetch(url); const j = await r.json(); showLog(j);
    if (j.ok) setPill(`만료까지 ${j.seconds_left}s`, true);
    else setPill('토큰 없음', false);
  }

  // 주문 동기화
  async function syncOrders(){
    const mall_id = $('mall').value, shop_no = $('shop').value;
    const start = $('startDate').value || '';
    const end   = $('endDate').value   || '';
    const qs = (start && end) ? `&start=${start}&end=${end}` : '';
    const url = `${BASE}/api/cafe24/orders/sync?mall_id=${mall_id}&shop_no=${shop_no}${qs}`;
    const r = await fetch(url); const j = await r.json(); showLog(j);
    await loadOrders(); // 동기화 후 즉시 갱신
  }

  // 초기화: 날짜 기본값 = 최근 7일
  function initDates(){
    const today = new Date();
    const end = today.toISOString().slice(0,10);
    const startDate = new Date(today.getTime()-6*24*3600*1000).toISOString().slice(0,10);
    $('startDate').value = startDate;
    $('endDate').value = end;
  }

  document.addEventListener('DOMContentLoaded', async ()=>{
    initDates();
    await checkStatus();
    await Promise.all([loadProducts(), loadOrders()]);
  });

  $('btnStatus').addEventListener('click', checkStatus);
  $('btnLoadProducts').addEventListener('click', loadProducts);
  $('btnLoadOrders').addEventListener('click', loadOrders);
  $('btnSync').addEventListener('click', syncOrders);
  </script>
</body>
</html>
