<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>ê³µê¸‰ì‚¬ ëŒ€ì‹œë³´ë“œ</title>

  <!-- Tailwind (ì‹œì—°ìš©) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- ì„ íƒ: ì‚¬ìš©ì CSS -->
  <link rel="stylesheet" href="/public/css/style.css">
</head>
<body class="bg-gray-50 min-h-screen">
  <header class="bg-white border-b sticky top-0 z-10">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <h1 class="text-xl font-semibold">ê³µê¸‰ì‚¬ ëŒ€ì‹œë³´ë“œ</h1>
      <div class="text-sm text-gray-500">ì½ê¸° ì „ìš© Â· Cafe24 ì—°ë™</div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-6 space-y-8">
    <!-- ì—°ê²°/ìƒíƒœ -->
    <section class="bg-white rounded-xl border p-4">
      <div class="flex flex-wrap items-end gap-3">
        <div>
          <label class="block text-sm text-gray-600">mall_id</label>
          <input id="mall" class="border rounded px-3 py-2" value="hanfen" />
        </div>
        <div>
          <label class="block text-sm text-gray-600">shop_no</label>
          <input id="shop" type="number" class="border rounded px-3 py-2 w-24" value="1" min="1"/>
        </div>
        <div class="flex gap-2">
          <button id="btnStatus" class="bg-blue-600 text-white px-4 py-2 rounded">ìƒíƒœ ì¡°íšŒ</button>
          <button id="btnSync"   class="px-4 py-2 rounded border">ì£¼ë¬¸ ë™ê¸°í™”</button>
        </div>
        <div class="ml-auto text-sm text-gray-500">
          <span id="pill" class="inline-block px-2 py-1 rounded border">-</span>
        </div>
      </div>

      <div class="mt-3 flex flex-wrap items-end gap-3">
        <div>
          <label class="block text-sm text-gray-600">ë™ê¸°í™” ì‹œì‘ì¼</label>
          <input id="startDate" type="date" class="border rounded px-3 py-2"/>
        </div>
        <div>
          <label class="block text-sm text-gray-600">ë™ê¸°í™” ì¢…ë£Œì¼</label>
          <input id="endDate" type="date" class="border rounded px-3 py-2"/>
        </div>
        <div class="text-sm text-gray-500">ê¸°ë³¸: ìµœê·¼ 7ì¼</div>
      </div>
    </section>

    <!-- KPI -->
    <section class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <div class="bg-white rounded-xl border p-4">
        <div class="text-sm text-gray-500">ìƒí’ˆ ìˆ˜</div>
        <div id="kpiProducts" class="text-2xl font-semibold">-</div>
      </div>
      <div class="bg-white rounded-xl border p-4">
        <div class="text-sm text-gray-500">ì£¼ë¬¸ ìˆ˜(ì „ì²´)</div>
        <div id="kpiOrders" class="text-2xl font-semibold">-</div>
      </div>
      <div class="bg-white rounded-xl border p-4">
        <div class="text-sm text-gray-500">êµ¬ë§¤í™•ì • ì£¼ë¬¸ ìˆ˜</div>
        <div id="kpiConfirmed" class="text-2xl font-semibold">-</div>
      </div>
    </section>

    <!-- ğŸ”¹ ë¦¬ì›Œë“œ ì„¤ì • (ì „ì—­/ì¸í”Œë£¨ì–¸ì„œë³„) -->
    <section class="bg-white rounded-xl border p-4">
      <div class="flex items-center justify-between">
        <h2 class="font-semibold">ë¦¬ì›Œë“œ ì„¤ì •</h2>
        <div class="flex gap-2">
          <button id="btnLoadReward" class="px-3 py-1 rounded border">ë¶ˆëŸ¬ì˜¤ê¸°</button>
          <button id="btnSaveReward" class="bg-green-600 text-white px-3 py-1 rounded">ì €ì¥</button>
        </div>
      </div>

      <div class="mt-4 grid md:grid-cols-2 gap-6">
        <div>
          <label class="block text-sm text-gray-600 mb-1">ì „ì—­ ê¸°ë³¸ìœ¨ (%)</label>
          <input id="defaultRate" type="number" step="0.1" min="0" max="100"
                 class="border rounded px-3 py-2 w-40" placeholder="ì˜ˆ: 10 (10%)"/>
          <p class="text-xs text-gray-500 mt-1">ì €ì¥ ì‹œ ìë™ìœ¼ë¡œ ì†Œìˆ˜(0.10)ë¡œ ë³€í™˜ë©ë‹ˆë‹¤.</p>
        </div>

        <div>
          <div class="flex items-center justify-between">
            <label class="block text-sm text-gray-600">ì¸í”Œë£¨ì–¸ì„œë³„ ê¸°ë³¸ìœ¨ (%)</label>
            <button id="btnAddRow" class="px-2 py-1 rounded border text-sm">í–‰ ì¶”ê°€</button>
          </div>
          <div class="mt-2 border rounded">
            <table class="min-w-full text-sm">
              <thead class="bg-gray-100 text-gray-600">
                <tr>
                  <th class="text-left px-3 py-2">influencer_id</th>
                  <th class="text-left px-3 py-2">ê¸°ë³¸ìœ¨(%)</th>
                  <th class="text-left px-3 py-2"></th>
                </tr>
              </thead>
              <tbody id="rate-rows"></tbody>
            </table>
          </div>
          <p class="text-xs text-gray-500 mt-1">* ë¹„ì›Œë‘ë©´ ì „ì—­ ê¸°ë³¸ìœ¨ì´ ì ìš©ë©ë‹ˆë‹¤.</p>
        </div>
      </div>
    </section>

    <!-- ğŸ”¹ í• ë‹¹/ë§í¬ ìƒì„± -->
    <section class="bg-white rounded-xl border p-4">
      <h2 class="font-semibold mb-3">í• ë‹¹ / ë§í¬ ìƒì„±</h2>
      <div class="grid md:grid-cols-3 gap-6">
        <div class="space-y-2">
          <label class="block text-sm text-gray-600">ìƒí’ˆë²ˆí˜¸ (product_no)</label>
          <input id="aProduct" type="number" class="border rounded px-3 py-2 w-full" placeholder="ì˜ˆ: 45"/>
          <label class="block text-sm text-gray-600 mt-2">ì¸í”Œë£¨ì–¸ì„œ ID</label>
          <input id="aInfluencer" class="border rounded px-3 py-2 w-full" placeholder="ì˜ˆ: inf-001"/>
          <div class="flex items-center gap-2 mt-2">
            <input id="aEnabled" type="checkbox" class="accent-blue-600" checked/>
            <label for="aEnabled" class="text-sm text-gray-700">í™œì„±í™”</label>
          </div>
          <label class="block text-sm text-gray-600 mt-2">ê°œë³„ìœ¨(%) (ì„ íƒ)</label>
          <input id="aRate" type="number" step="0.1" min="0" max="100" class="border rounded px-3 py-2 w-full" placeholder="ë¹„ì›Œë‘ë©´ ê¸°ë³¸ìœ¨"/>
          <button id="btnAssign" class="w-full bg-indigo-600 text-white px-3 py-2 rounded mt-2">í• ë‹¹ ì €ì¥</button>
        </div>

        <div class="space-y-2">
          <label class="block text-sm text-gray-600">ìº í˜ì¸ëª… (ì„ íƒ)</label>
          <input id="lCampaign" class="border rounded px-3 py-2 w-full" placeholder="ì˜ˆ: august"/>
          <button id="btnLink" class="w-full bg-slate-700 text-white px-3 py-2 rounded mt-2">ë§í¬ ìƒì„±</button>
          <div id="linkOut" class="text-sm text-gray-600 mt-2 break-all"></div>
        </div>

        <div class="text-sm text-gray-600">
          <p class="mb-2">â€¢ í• ë‹¹ ì €ì¥ â†’ ìƒí’ˆê³¼ ì¸í”Œë£¨ì–¸ì„œ ë§¤ì¹­ + (ì„ íƒ) ê°œë³„ìœ¨ ì„¤ì •</p>
          <p class="mb-2">â€¢ ë§í¬ ìƒì„± â†’ <code>/api/app/go/:code</code>ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸ë˜ì–´ ìƒí’ˆ ìƒì„¸ë¡œ ì´ë™í•˜ë©°, URLì— <code>rc</code> íŒŒë¼ë¯¸í„°ê°€ ë¶™ìŠµë‹ˆë‹¤.</p>
          <p class="mb-2">â€¢ êµ¬ë§¤í™•ì • ìƒíƒœì—ì„œë§Œ ë¦¬ì›Œë“œ í™•ì •ë©ë‹ˆë‹¤.</p>
        </div>
      </div>
    </section>

    <!-- ìƒí’ˆ ëª©ë¡ -->
    <section class="bg-white rounded-xl border">
      <div class="p-4 flex items-center justify-between gap-3">
        <h2 class="font-semibold">ìƒí’ˆ ëª©ë¡</h2>
        <div class="flex items-center gap-2 text-sm">
          <label>í˜ì´ì§€</label>
          <input id="prodPage" type="number" value="1" min="1" class="border rounded px-2 py-1 w-20">
          <label>ê°œìˆ˜</label>
          <input id="prodLimit" type="number" value="50" min="1" max="100" class="border rounded px-2 py-1 w-20">
          <button id="btnLoadProducts" class="px-3 py-1 rounded border">ìƒˆë¡œê³ ì¹¨</button>
        </div>
      </div>
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead class="bg-gray-100 text-gray-600">
            <tr>
              <th class="text-left px-4 py-2">ìƒí’ˆë²ˆí˜¸</th>
              <th class="text-left px-4 py-2">ìƒí’ˆëª…</th>
              <th class="text-left px-4 py-2">ê°€ê²©</th>
              <th class="text-left px-4 py-2">ìƒì„¸</th>
            </tr>
          </thead>
          <tbody id="product-list"></tbody>
        </table>
      </div>
    </section>

    <!-- ì£¼ë¬¸ ëª©ë¡ -->
    <section class="bg-white rounded-xl border">
      <div class="p-4 flex items-center justify-between gap-3">
        <h2 class="font-semibold">ì£¼ë¬¸ ëª©ë¡</h2>
        <div class="flex items-center gap-2 text-sm">
          <label>í™•ì • í•„í„°</label>
          <select id="confirmedSel" class="border rounded px-2 py-1">
            <option value="all">ì „ì²´</option>
            <option value="1">êµ¬ë§¤í™•ì •ë§Œ</option>
            <option value="0">ë¯¸í™•ì •ë§Œ</option>
          </select>
          <button id="btnLoadOrders" class="px-3 py-1 rounded border">ìƒˆë¡œê³ ì¹¨</button>
        </div>
      </div>
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead class="bg-gray-100 text-gray-600">
            <tr>
              <th class="text-left px-4 py-2">ì£¼ë¬¸ë²ˆí˜¸</th>
              <th class="text-left px-4 py-2">ëŒ€í‘œìƒí’ˆ</th>
              <th class="text-left px-4 py-2">ìˆ˜ëŸ‰</th>
              <th class="text-left px-4 py-2">ê²°ì œê¸ˆì•¡</th>
              <th class="text-left px-4 py-2">ì¸í”Œë£¨ì–¸ì„œ</th>
              <th class="text-left px-4 py-2">ë°°ì†¡/í™•ì • ìƒíƒœ</th>
            </tr>
          </thead>
          <tbody id="order-list"></tbody>
        </table>
      </div>
    </section>

    <!-- ë¡œê·¸ -->
    <section class="bg-white rounded-xl border p-4">
      <div class="text-sm text-gray-500">ìµœê·¼ ì‘ë‹µ</div>
      <pre id="out" class="bg-gray-900 text-gray-200 rounded p-3 overflow-auto" style="max-height:280px;">{}</pre>
    </section>
  </main>

  <script>
  const $ = (id)=>document.getElementById(id);
  const BASE = window.location.origin; // ê°™ì€ ì„œë²„

  function setPill(txt, ok=true) {
    const el = $('pill');
    el.textContent = txt;
    el.className = 'inline-block px-2 py-1 rounded border ' + (ok ? 'text-green-700 border-green-300' : 'text-amber-700 border-amber-300');
  }
  function showLog(obj){ $('out').textContent = JSON.stringify(obj, null, 2); }

  // ìˆ«ì ë³€í™˜ ìœ í‹¸
  const toNum = (v)=> (v===null||v===undefined||v==='') ? null : Number(v);
  const pctToDecimal = (pct)=> (pct===''||pct===null||pct===undefined) ? null : Math.max(0, Number(pct))/100;
  const decimalToPct = (dec)=> (dec===null||dec===undefined) ? '' : Math.round(Number(dec)*1000)/10; // í•œ ìë¦¬ ì†Œìˆ˜

  // KPI
  function sumQty(items){ return (items||[]).reduce((s,it)=> s + (Number(it.qty)||0), 0); }

  // ìƒíƒœ ì¡°íšŒ
  async function checkStatus(){
    const mall_id = $('mall').value, shop_no = $('shop').value;
    const url = `${BASE}/api/cafe24/ops/status?mall_id=${mall_id}&shop_no=${shop_no}`;
    const r = await fetch(url); const j = await r.json(); showLog(j);
    if (j.ok) setPill(`ë§Œë£Œê¹Œì§€ ${j.seconds_left}s`, true);
    else setPill('í† í° ì—†ìŒ', false);
  }

  // ì£¼ë¬¸ ë™ê¸°í™”
  async function syncOrders(){
    const mall_id = $('mall').value, shop_no = $('shop').value;
    const start = $('startDate').value || '';
    const end   = $('endDate').value   || '';
    const qs = (start && end) ? `&start=${start}&end=${end}` : '';
    const url = `${BASE}/api/cafe24/orders/sync?mall_id=${mall_id}&shop_no=${shop_no}${qs}`;
    const r = await fetch(url); const j = await r.json(); showLog(j);
    await loadOrders();
  }

  // ìƒí’ˆ
  async function loadProducts(){
    const mall_id = $('mall').value, shop_no = $('shop').value;
    const page = Number($('prodPage').value||1), limit = Math.max(1, Math.min(100, Number($('prodLimit').value||50)));
    const url = `${BASE}/api/cafe24/shop/products?mall_id=${mall_id}&shop_no=${shop_no}&limit=${limit}&page=${page}`;
    const r = await fetch(url); const j = await r.json(); showLog(j);

    const list = (j?.data?.products || j?.products || []);
    $('kpiProducts').textContent = list.length;
    const tbody = $('product-list'); tbody.innerHTML = '';
    list.forEach(p=>{
      const price = p.selling_price ?? p.price ?? '';
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="px-4 py-2">${p.product_no||''}</td>
        <td class="px-4 py-2">${p.product_name||p.name||''}</td>
        <td class="px-4 py-2">${price}</td>
        <td class="px-4 py-2">
          <a class="text-blue-600 underline" target="_blank"
             href="${BASE}/api/cafe24/shop/product/${p.product_no}/lean?mall_id=${mall_id}&shop_no=${shop_no}">
            lean ë³´ê¸°
          </a>
        </td>`;
      tbody.appendChild(tr);
    });
  }

  // ì£¼ë¬¸
  async function loadOrders(){
    const mall_id = $('mall').value, shop_no = $('shop').value;
    const sel = $('confirmedSel').value;
    const q = sel==='all' ? '' : `&confirmed=${sel}`;
    const url = `${BASE}/api/cafe24/orders/list?mall_id=${mall_id}&shop_no=${shop_no}${q}`;
    const r = await fetch(url); const j = await r.json(); showLog(j);

    const list = j?.orders || [];
    $('kpiOrders').textContent = list.length;
    $('kpiConfirmed').textContent = list.filter(o=>!!o.purchaseconfirmation_date).length;

    const tbody = $('order-list'); tbody.innerHTML = '';
    list.forEach(o=>{
      const name = (o.items?.[0]?.name) || '-';
      const qty = sumQty(o.items);
      const amount = o.total_price ?? 0;
      const influencer = o.influencer_id || 'â€”';
      let status = 'ë¯¸ë°œì†¡';
      if (o.shipbegin_date) status = 'ë°°ì†¡ì¤‘';
      if (o.shipend_date)   status = 'ë°°ì†¡ì™„ë£Œ';
      if (o.purchaseconfirmation_date) status = 'êµ¬ë§¤í™•ì •';
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="px-4 py-2">${o.order_no||''}</td>
        <td class="px-4 py-2">${name}</td>
        <td class="px-4 py-2">${qty}</td>
        <td class="px-4 py-2">${amount}</td>
        <td class="px-4 py-2">${influencer}</td>
        <td class="px-4 py-2">${status}</td>`;
      tbody.appendChild(tr);
    });
  }

  // ğŸ”¸ ë¦¬ì›Œë“œ ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸°
  async function loadReward(){
    const mall_id = $('mall').value, shop_no = $('shop').value;
    const u = `${BASE}/api/app/supplier/rewards/config?mall_id=${mall_id}&shop_no=${shop_no}`;
    const r = await fetch(u); const j = await r.json(); showLog(j);

    // ì „ì—­ìœ¨
    $('defaultRate').value = decimalToPct(j.default_rate ?? 0.1);

    // ì¸í”Œë£¨ì–¸ì„œë³„ í‘œ
    const tbody = $('rate-rows'); tbody.innerHTML = '';
    const map = j.influencers || {};
    Object.keys(map).forEach(id=>{
      addRateRow(id, decimalToPct(map[id]));
    });
  }

  // ğŸ”¸ ë¦¬ì›Œë“œ ì„¤ì • ì €ì¥
  async function saveReward(){
    const mall_id = $('mall').value, shop_no = $('shop').value;

    // ì „ì—­ìœ¨
    const default_rate = pctToDecimal($('defaultRate').value);

    // ì¸í”Œë£¨ì–¸ì„œë³„
    const rows = Array.from(document.querySelectorAll('#rate-rows tr'));
    const influencers = {};
    rows.forEach(tr=>{
      const id = tr.querySelector('input[data-k="id"]').value.trim();
      const pct = tr.querySelector('input[data-k="rate"]').value;
      if (!id) return;
      const dec = pctToDecimal(pct);
      if (dec !== null) influencers[id] = dec;
    });

    const u = `${BASE}/api/app/supplier/rewards/config?mall_id=${mall_id}&shop_no=${shop_no}`;
    const r = await fetch(u, {
      method:'PUT',
      headers:{ 'Content-Type':'application/json' },
      body: JSON.stringify({ default_rate, influencers })
    });
    const j = await r.json(); showLog(j);
    if (j.ok) alert('ì €ì¥ ì™„ë£Œ');
  }

  // ğŸ”¸ í• ë‹¹ ì €ì¥
  async function doAssign(){
    const mall_id = $('mall').value, shop_no = $('shop').value;
    const product_no = Number($('aProduct').value);
    const influencer_id = $('aInfluencer').value.trim();
    const enabled = $('aEnabled').checked;
    const commission_rate = pctToDecimal($('aRate').value);
    if (!product_no || !influencer_id) return alert('product_noì™€ influencer_idë¥¼ ì…ë ¥í•˜ì„¸ìš”.');

    const u = `${BASE}/api/app/supplier/assign?mall_id=${mall_id}&shop_no=${shop_no}`;
    const r = await fetch(u, {
      method:'POST',
      headers:{ 'Content-Type':'application/json' },
      body: JSON.stringify({ product_no, influencer_id, enabled, commission_rate })
    });
    const j = await r.json(); showLog(j);
    if (j.ok) alert('í• ë‹¹ ì €ì¥ ì™„ë£Œ');
  }

  // ğŸ”¸ ë§í¬ ìƒì„±
  async function doLink(){
    const mall_id = $('mall').value, shop_no = $('shop').value;
    const product_no = Number($('aProduct').value);
    const influencer_id = $('aInfluencer').value.trim();
    const campaign = $('lCampaign').value.trim() || null;
    if (!product_no || !influencer_id) return alert('product_noì™€ influencer_idë¥¼ ì…ë ¥í•˜ì„¸ìš”.');

    const u = `${BASE}/api/app/supplier/link?mall_id=${mall_id}&shop_no=${shop_no}`;
    const r = await fetch(u, {
      method:'POST',
      headers:{ 'Content-Type':'application/json' },
      body: JSON.stringify({ product_no, influencer_id, campaign })
    });
    const j = await r.json(); showLog(j);
    if (j.ok) {
      const full = `${BASE}/api/app/go/${j.code}`;
      $('linkOut').innerHTML = `ì½”ë“œ: <code>${j.code}</code><br/>ë§í¬: <a class="text-blue-600 underline" href="${full}" target="_blank">${full}</a>`;
    }
  }

  // ì¸í”Œë£¨ì–¸ì„œìœ¨ í–‰ ì¶”ê°€/ì‚­ì œ
  function addRateRow(id='', pct=''){
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="px-3 py-2"><input data-k="id" class="border rounded px-2 py-1 w-full" placeholder="inf-001" value="${id}"/></td>
      <td class="px-3 py-2"><input data-k="rate" type="number" step="0.1" min="0" max="100" class="border rounded px-2 py-1 w-28" placeholder="ì˜ˆ: 12.5" value="${pct}"/></td>
      <td class="px-3 py-2 text-right"><button class="px-2 py-1 rounded border text-xs" onclick="this.closest('tr').remove()">ì‚­ì œ</button></td>
    `;
    $('rate-rows').appendChild(tr);
  }

  // ì´ˆê¸°í™”: ë‚ ì§œ ê¸°ë³¸ê°’ = ìµœê·¼ 7ì¼
  function initDates(){
    const today = new Date();
    const end = today.toISOString().slice(0,10);
    const startDate = new Date(today.getTime()-6*24*3600*1000).toISOString().slice(0,10);
    $('startDate').value = startDate;
    $('endDate').value = end;
  }

  // ì´ˆê¸° ë¡œë“œ
  document.addEventListener('DOMContentLoaded', async ()=>{
    initDates();
    await checkStatus();
    await Promise.all([loadProducts(), loadOrders(), loadReward()]);
  });

  // ì´ë²¤íŠ¸ ë°”ì¸ë”©
  $('btnStatus').addEventListener('click', checkStatus);
  $('btnSync').addEventListener('click', syncOrders);
  $('btnLoadProducts').addEventListener('click', loadProducts);
  $('btnLoadOrders').addEventListener('click', loadOrders);

  $('btnLoadReward').addEventListener('click', loadReward);
  $('btnSaveReward').addEventListener('click', saveReward);
  $('btnAddRow').addEventListener('click', ()=>addRateRow());

  $('btnAssign').addEventListener('click', doAssign);
  $('btnLink').addEventListener('click', doLink);
  </script>
</body>
</html>
