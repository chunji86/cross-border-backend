<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>관리자 대시보드</title>

  <!-- (선택) Tailwind 유틸이 꼭 필요하면 남기되, 친구 CSS가 나중에 오게 두세요 -->
  <!-- <script src="https://cdn.tailwindcss.com"></script> -->

  <!-- 친구 CSS (우선 적용) -->
  <link rel="stylesheet" href="/public/css/style.css">
  <style>
    /* 레이아웃 유틸 약간만 보강 */
    .grid-4 { display:grid; grid-template-columns: repeat(4, 1fr); gap:16px; }
    .grid-1 { display:grid; grid-template-columns: 1fr; gap:16px; }
    .mt-16 { margin-top: 16px; }
    .mb-0 { margin-bottom: 0; }
    .muted { color:#6B7280; font-size:12px; }
    .pill { display:inline-block; padding:4px 8px; border-radius:8px; border:1px solid #e5e7eb; font-size:12px; }
    .text-right { text-align:right; }
    .overflow-auto { overflow:auto; }
  </style>
</head>

<body>
  <header class="navbar">
    <div class="container" style="padding:12px 15px; display:flex; align-items:center; justify-content:space-between;">
      <h1 class="text-white" style="margin:0; font-size:18px; font-weight:600;">관리자 대시보드</h1>
      <div class="muted" style="color:#e5e7eb;">읽기 전용 · Cafe24 연동</div>
    </div>
  </header>

  <main class="container" style="padding:24px 15px;">
    <!-- 컨트롤 -->
    <section class="card" style="padding:16px;">
      <div style="display:flex; flex-wrap:wrap; gap:12px; align-items:flex-end;">
        <div>
          <label class="muted">mall_id</label><br/>
          <input id="mall" class="form-control" value="hanfen" style="width:200px;"/>
        </div>
        <div>
          <label class="muted">shop_no</label><br/>
          <input id="shop" type="number" class="form-control" value="1" min="1" style="width:100px;"/>
        </div>
        <div>
          <label class="muted">시작일</label><br/>
          <input id="startDate" type="date" class="form-control" style="width:160px;"/>
        </div>
        <div>
          <label class="muted">종료일</label><br/>
          <input id="endDate" type="date" class="form-control" style="width:160px;"/>
        </div>
        <div style="display:flex; gap:8px;">
          <button id="btnStatus" class="btn btn-primary">상태 조회</button>
          <button id="btnSync"   class="btn">주문 동기화</button>
          <button id="btnReload" class="btn">데이터 새로고침</button>
        </div>
        <div style="margin-left:auto;">
          <span id="pill" class="pill">-</span>
        </div>
      </div>
    </section>

    <!-- KPI -->
    <section class="grid-4 mt-16">
      <div class="card" style="padding:16px;">
        <div class="muted">총 주문</div><div id="kpiAll" style="font-size:24px; font-weight:600;">-</div>
      </div>
      <div class="card" style="padding:16px;">
        <div class="muted">구매확정</div><div id="kpiConfirmed" style="font-size:24px; font-weight:600;">-</div>
      </div>
      <div class="card" style="padding:16px;">
        <div class="muted">확정 매출</div><div id="kpiRevenue" style="font-size:24px; font-weight:600;">-</div>
      </div>
      <div class="card" style="padding:16px;">
        <div class="muted">인플루언서 수</div><div id="kpiInfluencers" style="font-size:24px; font-weight:600;">-</div>
      </div>
    </section>

    <!-- Top 인플루언서 -->
    <section class="card mt-16">
      <div style="padding:16px; display:flex; align-items:center; justify-content:space-between;">
        <h2 style="margin:0; font-weight:600;">Top 인플루언서 (확정 매출)</h2>
      </div>
      <div class="table-responsive">
        <table class="table">
          <thead>
            <tr>
              <th>인플루언서</th>
              <th>확정 주문 수</th>
              <th>확정 매출 합계</th>
            </tr>
          </thead>
          <tbody id="rank-list"></tbody>
        </table>
      </div>
    </section>

    <!-- 최근 주문 -->
    <section class="card mt-16">
      <div style="padding:16px;"><h2 style="margin:0; font-weight:600;">최근 주문</h2></div>
      <div class="table-responsive">
        <table class="table">
          <thead>
            <tr>
              <th>주문번호</th>
              <th>대표상품</th>
              <th>수량</th>
              <th>금액</th>
              <th>인플루언서</th>
              <th>상태</th>
            </tr>
          </thead>
          <tbody id="order-list"></tbody>
        </table>
      </div>
    </section>

    <!-- 로그 -->
    <section class="card mt-16" style="padding:16px;">
      <div class="muted">최근 응답</div>
      <pre id="out" class="fade-in" style="background:#111827; color:#e5e7eb; border-radius:8px; padding:12px; max-height:260px;" class="overflow-auto">{}</pre>
    </section>
  </main>

  <script>
  const $ = id => document.getElementById(id);
  const BASE = window.location.origin;

  function setPill(txt, ok=true){
    const el = $('pill');
    el.textContent = txt;
    el.style.color = ok ? '#065F46' : '#92400E';
    el.style.borderColor = ok ? '#BBF7D0' : '#FDE68A';
    el.style.background = ok ? '#D1FAE5' : '#FEF3C7';
  }
  function showLog(obj){ $('out').textContent = JSON.stringify(obj, null, 2); }
  function sumQty(items){ return (items||[]).reduce((s,it)=> s + (Number(it.qty)||0), 0); }
  function statusLabel(o){
    if (o.purchaseconfirmation_date) return '구매확정';
    if (o.shipend_date) return '배송완료';
    if (o.shipbegin_date) return '배송중';
    return '미발송';
  }

  function agg(orders){
    const all = orders.length;
    const confirmedOrders = orders.filter(o=>!!o.purchaseconfirmation_date);
    const confirmed = confirmedOrders.length;
    const revenue = confirmedOrders.reduce((s,o)=> s + (Number(o.total_price)||0), 0);

    const byInf = {};
    confirmedOrders.forEach(o=>{
      const id = o.influencer_id || '—';
      if (!byInf[id]) byInf[id] = { id, orders: 0, revenue: 0 };
      byInf[id].orders += 1;
      byInf[id].revenue += Number(o.total_price)||0;
    });
    const rank = Object.values(byInf).sort((a,b)=> b.revenue - a.revenue);

    return { all, confirmed, revenue, rank };
  }

  async function fetchOrders({ confirmed=null } = {}){
    const mall_id = $('mall').value, shop_no = $('shop').value;
    const q = confirmed==null ? '' : `&confirmed=${confirmed?1:0}`;
    const u = `${BASE}/api/cafe24/orders/list?mall_id=${mall_id}&shop_no=${shop_no}${q}`;
    const r = await fetch(u); const j = await r.json(); showLog(j);
    return j?.orders || [];
  }

  async function reload(){
    const orders = await fetchOrders({ confirmed: null });
    const { all, confirmed, revenue, rank } = agg(orders);
    $('kpiAll').textContent       = all;
    $('kpiConfirmed').textContent = confirmed;
    $('kpiRevenue').textContent   = new Intl.NumberFormat('ko-KR').format(revenue);
    $('kpiInfluencers').textContent = new Set(orders.map(o=>o.influencer_id).filter(Boolean)).size;

    // Top 인플루언서
    const tbody1 = $('rank-list'); tbody1.innerHTML = '';
    rank.forEach(r=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${r.id}</td>
        <td>${r.orders}</td>
        <td>${new Intl.NumberFormat('ko-KR').format(r.revenue)}</td>`;
      tbody1.appendChild(tr);
    });

    // 최근 주문
    const tbody2 = $('order-list'); tbody2.innerHTML = '';
    orders.slice(-50).reverse().forEach(o=>{
      const name = (o.items?.[0]?.name)||'-';
      const qty  = sumQty(o.items);
      const amt  = o.total_price ?? 0;
      const st   = statusLabel(o);
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${o.order_no||''}</td>
        <td>${name}</td>
        <td>${qty}</td>
        <td>${amt}</td>
        <td>${o.influencer_id||'—'}</td>
        <td>${st}</td>`;
      tbody2.appendChild(tr);
    });
  }

  async function syncOrders(){
    const mall_id = $('mall').value, shop_no = $('shop').value;
    const start = $('startDate').value || '';
    const end   = $('endDate').value   || '';
    const qs = (start && end) ? `&start=${start}&end=${end}` : '';
    const u = `${BASE}/api/cafe24/orders/sync?mall_id=${mall_id}&shop_no=${shop_no}${qs}`;
    const r = await fetch(u); const j = await r.json(); showLog(j);
    await reload();
  }

  async function checkStatus(){
    const mall_id = $('mall').value, shop_no = $('shop').value;
    const u = `${BASE}/api/cafe24/ops/status?mall_id=${mall_id}&shop_no=${shop_no}`;
    const r = await fetch(u); const j = await r.json(); showLog(j);
    setPill(j.ok ? `만료까지 ${j.seconds_left}s` : '토큰 없음', !!j.ok);
  }

  function initDates(){
    const today = new Date();
    const end = today.toISOString().slice(0,10);
    const startDate = new Date(today.getTime()-6*24*3600*1000).toISOString().slice(0,10);
    $('startDate').value = startDate;
    $('endDate').value = end;
  }

  document.addEventListener('DOMContentLoaded', async ()=>{
    initDates();
    await checkStatus();
    await reload();
  });
  $('btnStatus').addEventListener('click', checkStatus);
  $('btnSync').addEventListener('click', syncOrders);
  $('btnReload').addEventListener('click', reload);
  </script>
</body>
</html>
