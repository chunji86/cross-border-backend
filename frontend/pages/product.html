<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ìƒí’ˆ ìƒì„¸ - ë¼ì¿¤</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="/frontend/assets/js/auth.js"></script>
</head>
<body class="bg-gray-50 min-h-screen">
  <header class="bg-white shadow p-4">
    <div class="max-w-5xl mx-auto flex justify-between items-center">
      <h1 class="text-xl font-bold text-gray-800">ğŸ›ï¸ ìƒí’ˆ ìƒì„¸ë³´ê¸°</h1>
      <a href="/frontend/pages/index.html" class="text-sm text-blue-500 hover:underline">í™ˆìœ¼ë¡œ</a>
    </div>
  </header>

  <main class="max-w-5xl mx-auto px-4 py-8">
    <div id="product-container" class="bg-white p-6 rounded-lg shadow-md">
      <!-- ìƒí’ˆ ì •ë³´ê°€ ì—¬ê¸°ì— ì‚½ì…ë©ë‹ˆë‹¤ -->
    </div>
  </main>

  <script>
    document.addEventListener("DOMContentLoaded", async () => {
      const urlParams = new URLSearchParams(window.location.search);
      const productId = urlParams.get("id");

      if (!productId) {
        alert("ìƒí’ˆ IDê°€ ì—†ìŠµë‹ˆë‹¤.");
        window.location.href = "/frontend/pages/index.html";
        return;
      }

      try {
        const res = await fetch(`/api/products/${productId}`);
        const product = await res.json();

        if (product.error) {
          document.getElementById("product-container").innerHTML = `<p class="text-red-500">${product.error}</p>`;
          return;
        }

        const container = document.getElementById("product-container");
        container.innerHTML = `
          <img src="${product.imageUrl}" alt="${product.name}" class="w-full h-80 object-cover rounded-lg mb-6" />
          <h2 class="text-2xl font-semibold mb-2">${product.name}</h2>
          <p class="text-gray-600 mb-2">${product.description}</p>
          <p class="text-lg font-bold text-gray-800 mb-2">ê°€ê²©: ${product.price.toLocaleString()}ì›</p>
          <p class="text-sm text-green-600 mb-6">ë¦¬ì›Œë“œìœ¨: ${Math.round(product.rewardRate * 100)}%</p>
          <div class="flex space-x-4">
            <button onclick="orderProduct(${product.id})" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded">
              êµ¬ë§¤í•˜ê¸°
            </button>
            <button onclick='addToCart(${JSON.stringify(product)})' class="px-4 py-2 bg-yellow-400 hover:bg-yellow-500 text-white rounded">
              ì¥ë°”êµ¬ë‹ˆì— ë‹´ê¸°
            </button>
          </div>
        `;
      } catch (err) {
        console.error("ìƒí’ˆ ì¡°íšŒ ì‹¤íŒ¨:", err);
        alert("ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      }
    });

    async function orderProduct(productId) {
      const token = localStorage.getItem("token");
      if (!token) {
        alert("ë¡œê·¸ì¸ í›„ ì´ìš©í•´ì£¼ì„¸ìš”.");
        window.location.href = "/frontend/pages/login.html";
        return;
      }

      const res = await fetch("/api/orders", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${token}`
        },
        body: JSON.stringify({ productId })
      });

      const data = await res.json();
      if (data.success) {
        alert("ì£¼ë¬¸ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!");
        window.location.href = "/frontend/pages/index.html";
      } else {
        alert(data.error || "ì£¼ë¬¸ ì‹¤íŒ¨");
      }
    }

    // âœ… ì¥ë°”êµ¬ë‹ˆ ë‹´ê¸° í•¨ìˆ˜ (ë¡œì»¬ìŠ¤í† ë¦¬ì§€ í™œìš©)
    function addToCart(product) {
      const cart = JSON.parse(localStorage.getItem("cart")) || [];

      const existingItem = cart.find(item => item.id === product.id);
      if (existingItem) {
        existingItem.quantity += 1;
      } else {
        cart.push({
          id: product.id,
          name: product.name,
          price: product.price,
          imageUrl: product.imageUrl,
          quantity: 1
        });
      }

      localStorage.setItem("cart", JSON.stringify(cart));
      alert("ì¥ë°”êµ¬ë‹ˆì— ìƒí’ˆì´ ë‹´ê²¼ìŠµë‹ˆë‹¤!");
    }
  </script>
</body>
</html>
